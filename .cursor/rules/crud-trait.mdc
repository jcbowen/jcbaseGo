# CRUD Trait ç»„ä»¶ä½¿ç”¨è§„èŒƒ

## ç»„ä»¶æ¦‚è¿°

CRUD Trait ç»„ä»¶ä½äº [component/trait/crud/](mdc:component/trait/crud/)ï¼Œæä¾›äº†å®Œæ•´çš„å¢åˆ æ”¹æŸ¥åŠŸèƒ½ï¼Œæ”¯æŒä¸°å¯Œçš„é’©å­æ–¹æ³•è¿›è¡Œä¸šåŠ¡é€»è¾‘æ‰©å±•ã€‚

### ä¸»è¦ç‰¹æ€§

- ğŸš€ **å¼€ç®±å³ç”¨**: æä¾›å®Œæ•´çš„ CRUD æ“ä½œ
- ğŸ”§ **é«˜åº¦å¯æ‰©å±•**: ä¸°å¯Œçš„é’©å­æ–¹æ³•æ”¯æŒè‡ªå®šä¹‰é€»è¾‘
- ğŸ›¡ï¸ **äº‹åŠ¡å®‰å…¨**: è‡ªåŠ¨äº‹åŠ¡ç®¡ç†ï¼Œæ”¯æŒå›æ»š
- ğŸ“Š **åˆ†é¡µæ”¯æŒ**: å†…ç½®åˆ†é¡µåŠŸèƒ½
- ğŸ—‘ï¸ **è½¯åˆ é™¤**: æ”¯æŒè½¯åˆ é™¤å’Œç¡¬åˆ é™¤ï¼Œå¯è‡ªå®šä¹‰è½¯åˆ é™¤å­—æ®µå
- ğŸ” **çµæ´»æŸ¥è¯¢**: æ”¯æŒå¤æ‚æŸ¥è¯¢æ¡ä»¶
- ğŸ”„ **æ‰¹é‡æ“ä½œ**: æ”¯æŒæ‰¹é‡åˆ é™¤å’Œæ›´æ–°
- ğŸ“ **å­—æ®µè®¾ç½®**: æ”¯æŒå•ä¸ªå­—æ®µå€¼è®¾ç½®

## æ ¸å¿ƒæ¶æ„

### Trait ç»“æ„ä½“
```go
type Trait struct {
    // ----- åŸºç¡€é…ç½® ----- //
    PkId               string       `default:"id"` // æ•°æ®è¡¨ä¸»é”®
    Model              any          // æ¨¡å‹æŒ‡é’ˆ
    ModelTableAlias    string       // æ¨¡å‹è¡¨åˆ«å
    DBI                orm.Instance // æ•°æ®åº“å®ä¾‹
    ListResultStruct   interface{}  // åˆ—è¡¨è¿”å›ç»“æ„ä½“
    DetailResultStruct interface{}  // è¯¦æƒ…è¿”å›ç»“æ„ä½“
    Controller         interface{}  // æ§åˆ¶å™¨

    // ----- åˆå§‹åŒ–æ—¶ç”Ÿæˆ ----- //
    ModelTableName      string   // æ¨¡å‹è¡¨å
    ModelFields         []string // æ¨¡å‹æ‰€æœ‰å­—æ®µ
    SoftDeleteField     string   // è½¯åˆ é™¤å­—æ®µå
    SoftDeleteCondition string   // è½¯åˆ é™¤åˆ¤æ–­æ¡ä»¶
    OperateTime         string   // æ“ä½œæ—¶é—´
    TableAlias          string   // è¡¨åˆ«å
}
```

### Instance æ¥å£
```go
// Instance å®šä¹‰æ•°æ®åº“å®ä¾‹æ¥å£
type Instance interface {
    // GetDb è·å–æ•°æ®åº“è¿æ¥
    GetDb() *gorm.DB
}
```

## åŸºç¡€ä½¿ç”¨æ–¹æ³•

### æ§åˆ¶å™¨é›†æˆ
```go
package user

import (
    "github.com/jcbowen/jcbaseGo/component/trait/crud"
    "github.com/jcbowen/jcbaseGo/component/orm/mysql"
    "officeAutomation/controllers/base"
    "officeAutomation/library"
    userModel "officeAutomation/model/common/user"
)

type Index struct {
    base.Controller
    *crud.Trait
}

// New åˆå§‹åŒ– CRUD æ§åˆ¶å™¨
func New() *Index {
    // MySQL ç¤ºä¾‹
    index := &Index{
        Trait: &crud.Trait{
            Model: &userModel.Account{},  // æ•°æ®æ¨¡å‹
            DBI:   library.Mysql,        // æ•°æ®åº“å®ä¾‹
        },
    }
    
    index.Trait.Controller = index
    return index
}

// SQLite ç¤ºä¾‹
/*
func New() *Index {
    sqliteDb, err := sqlite.New(jcbaseGo.SqlLiteStruct{
        DbFile: "path/to/your/database.db",
    })
    if err != nil {
        panic(err)
    }
    
    index := &Index{
        Trait: &crud.Trait{
            Model: &userModel.Account{},
            DBI:   sqliteDb,
        },
    }
    
    index.Trait.Controller = index
    return index
}
*/
```

### è·¯ç”±é…ç½®
```go
systemGroup := r.Group("/system")
systemGroup.Use(middleware.LoginRequired())
{
    systemUserGroup := systemGroup.Group("/user")
    {
        systemUser := systemUserController.New()
        systemUserGroup.GET("/list", systemUser.ActionList)        // è·å–åˆ—è¡¨
        systemUserGroup.GET("/detail", systemUser.ActionDetail)    // è·å–è¯¦æƒ…
        systemUserGroup.POST("/create", systemUser.ActionCreate)   // åˆ›å»º
        systemUserGroup.POST("/update", systemUser.ActionUpdate)   // æ›´æ–°
        systemUserGroup.POST("/save", systemUser.ActionSave)       // ä¿å­˜ï¼ˆè‡ªåŠ¨åˆ¤æ–­åˆ›å»º/æ›´æ–°ï¼‰
        systemUserGroup.POST("/delete", systemUser.ActionDelete)   // åˆ é™¤
        systemUserGroup.GET("/all", systemUser.ActionAll)          // è·å–æ‰€æœ‰æ•°æ®
        systemUserGroup.POST("/set-value", systemUser.ActionSetValue) // è®¾ç½®å­—æ®µå€¼
    }
}
```

## API æ¥å£è¯¦è§£

### ActionCreate - åˆ›å»ºæ•°æ®
- **HTTPæ–¹æ³•**: POST
- **åŠŸèƒ½**: åˆ›å»ºæ–°çš„æ•°æ®è®°å½•
- **è¯·æ±‚å‚æ•°**: æ¨¡å‹å¯¹åº”çš„å­—æ®µæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
- **è¿”å›**: åˆ›å»ºæˆåŠŸçš„æ•°æ®è®°å½•

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
    "username": "john_doe",
    "email": "john@example.com",
    "status": 1
}
```

### ActionUpdate - æ›´æ–°æ•°æ®
- **HTTPæ–¹æ³•**: POST
- **åŠŸèƒ½**: æ›´æ–°ç°æœ‰æ•°æ®è®°å½•
- **è¯·æ±‚å‚æ•°**: åŒ…å«ä¸»é”®IDå’Œè¦æ›´æ–°çš„å­—æ®µæ•°æ®
- **è¿”å›**: æ›´æ–°æˆåŠŸçš„æ•°æ®è®°å½•

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
    "id": 123,
    "username": "john_updated",
    "email": "john_new@example.com"
}
```

### ActionDelete - åˆ é™¤æ•°æ®
- **HTTPæ–¹æ³•**: POST
- **åŠŸèƒ½**: åˆ é™¤æ•°æ®è®°å½•ï¼ˆæ”¯æŒæ‰¹é‡åˆ é™¤ï¼‰
- **è¯·æ±‚å‚æ•°**: `{ä¸»é”®å}s` - IDæ•°ç»„
- **è¿”å›**: åˆ é™¤æˆåŠŸçš„æ¶ˆæ¯

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
    "ids": [1, 2, 3]
}
```

### ActionList - è·å–æ•°æ®åˆ—è¡¨
- **HTTPæ–¹æ³•**: GET
- **åŠŸèƒ½**: è·å–åˆ†é¡µæ•°æ®åˆ—è¡¨
- **æŸ¥è¯¢å‚æ•°**:
  - `page`: é¡µç ï¼ˆé»˜è®¤1ï¼‰
  - `page_size`: æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤10ï¼Œæœ€å¤§1000ï¼‰
  - `show_deleted`: æ˜¯å¦æ˜¾ç¤ºå·²åˆ é™¤æ•°æ®ï¼ˆ0/1ï¼Œé»˜è®¤0ï¼‰
- **è¿”å›**: åŒ…å«åˆ†é¡µä¿¡æ¯çš„æ•°æ®åˆ—è¡¨

**è¯·æ±‚ç¤ºä¾‹**: `GET /api/user/list?page=1&page_size=20`

### ActionDetail - è·å–æ•°æ®è¯¦æƒ…
- **HTTPæ–¹æ³•**: GET
- **åŠŸèƒ½**: è·å–å•æ¡æ•°æ®çš„è¯¦ç»†ä¿¡æ¯
- **æŸ¥è¯¢å‚æ•°**: ä¸»é”®ID
- **è¿”å›**: æ•°æ®è¯¦æƒ…

**è¯·æ±‚ç¤ºä¾‹**: `GET /api/user/detail?id=123`

### ActionAll - è·å–æ‰€æœ‰æ•°æ®
- **HTTPæ–¹æ³•**: GET
- **åŠŸèƒ½**: è·å–æ‰€æœ‰æ•°æ®ï¼ˆä¸åˆ†é¡µï¼‰
- **æŸ¥è¯¢å‚æ•°**:
  - `show_deleted`: æ˜¯å¦æ˜¾ç¤ºå·²åˆ é™¤æ•°æ®ï¼ˆ0/1ï¼Œé»˜è®¤0ï¼‰
- **è¿”å›**: æ‰€æœ‰æ•°æ®åˆ—è¡¨

**è¯·æ±‚ç¤ºä¾‹**: `GET /api/user/all`

### ActionSave - æ™ºèƒ½ä¿å­˜
- **HTTPæ–¹æ³•**: POST
- **åŠŸèƒ½**: è‡ªåŠ¨åˆ¤æ–­åˆ›å»ºæˆ–æ›´æ–°æ“ä½œ
- **é€»è¾‘**: å¦‚æœåŒ…å«ä¸»é”®IDåˆ™æ›´æ–°ï¼Œå¦åˆ™åˆ›å»º
- **è¯·æ±‚å‚æ•°**: æ¨¡å‹å¯¹åº”çš„å­—æ®µæ•°æ®
- **è¿”å›**: ä¿å­˜æˆåŠŸçš„æ•°æ®è®°å½•

### ActionSetValue - è®¾ç½®å­—æ®µå€¼
- **HTTPæ–¹æ³•**: POST
- **åŠŸèƒ½**: è®¾ç½®å•ä¸ªå­—æ®µçš„å€¼
- **è¯·æ±‚å‚æ•°**:
  - ä¸»é”®ID
  - `field`: å­—æ®µå
  - `value`: å­—æ®µå€¼
- **è¿”å›**: è®¾ç½®æˆåŠŸçš„æ¶ˆæ¯

**è¯·æ±‚ç¤ºä¾‹**:
```json
{
    "id": 123,
    "field": "status",
    "value": 0
}
```

## è½¯åˆ é™¤é…ç½®è¯¦è§£

### é…ç½®æ–¹å¼
é€šè¿‡åœ¨æ¨¡å‹å­—æ®µçš„ `gorm` æ ‡ç­¾ä¸­æ·»åŠ  `soft_delete` æ ‡ç­¾æ¥é…ç½®è½¯åˆ é™¤ï¼š

```go
import "github.com/jcbowen/jcbaseGo/component/orm/base"

type User struct {
    base.MysqlBaseModel  // åŒ…å«é»˜è®¤çš„è½¯åˆ é™¤å­—æ®µ
    Name string `gorm:"column:name;size:100" json:"name"`

    // æ–¹å¼1: ä½¿ç”¨ç³»ç»Ÿé»˜è®¤çš„ deleted_at å­—æ®µï¼ˆæ¨èï¼‰
    // åŸºç¡€æ¨¡å‹å·²åŒ…å«ï¼Œæ— éœ€é¢å¤–å®šä¹‰

    // æ–¹å¼2: è‡ªå®šä¹‰è½¯åˆ é™¤å­—æ®µï¼Œæ¡ä»¶ä¸º IS NULL
    // IsDeleted string `gorm:"column:is_deleted;type:DATETIME;soft_delete:IS NULL" json:"is_deleted"`

    // æ–¹å¼3: ä½¿ç”¨çŠ¶æ€å­—æ®µä½œä¸ºè½¯åˆ é™¤ï¼Œæ¡ä»¶ä¸º = 1ï¼ˆè¡¨ç¤ºæ­£å¸¸çŠ¶æ€ï¼‰
    // Status int `gorm:"column:status;type:INT;soft_delete:= 1" json:"status"`

    // æ–¹å¼4: ä½¿ç”¨ç‰¹æ®Šé»˜è®¤å€¼çš„ deleted_at å­—æ®µ
    // DeletedAt string `gorm:"column:deleted_at;type:DATETIME;default:0000-00-00 00:00:00" json:"deleted_at"`
}
```

### é…ç½®è¯´æ˜
1. **é»˜è®¤é…ç½®**ï¼šå¦‚æœæ¨¡å‹ä¸­å­˜åœ¨ `deleted_at` å­—æ®µä¸”æ²¡æœ‰ `soft_delete` æ ‡ç­¾ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†å…¶ä½œä¸ºè½¯åˆ é™¤å­—æ®µï¼Œæ¡ä»¶ä¸º `IS NULL`
2. **è‡ªå®šä¹‰å­—æ®µå**ï¼šé€šè¿‡ `soft_delete` æ ‡ç­¾å¯ä»¥æŒ‡å®šä»»æ„å­—æ®µä½œä¸ºè½¯åˆ é™¤å­—æ®µ
3. **è‡ªå®šä¹‰æ¡ä»¶**ï¼š`soft_delete` æ ‡ç­¾çš„å€¼å°±æ˜¯è½¯åˆ é™¤çš„åˆ¤æ–­æ¡ä»¶
4. **ç‰¹æ®Šé»˜è®¤å€¼**ï¼šå¦‚æœ `deleted_at` å­—æ®µçš„é»˜è®¤å€¼ä¸º `0000-00-00 00:00:00`ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨ä½¿ç”¨ç›¸åº”æ¡ä»¶

### ä½¿ç”¨æ•ˆæœ
- **æŸ¥è¯¢æ—¶**ï¼šç³»ç»Ÿä¼šè‡ªåŠ¨æ·»åŠ è½¯åˆ é™¤æ¡ä»¶ï¼ŒåªæŸ¥è¯¢æœªåˆ é™¤çš„æ•°æ®
- **åˆ é™¤æ—¶**ï¼šæ‰§è¡Œè½¯åˆ é™¤æ“ä½œï¼Œæ›´æ–°è½¯åˆ é™¤å­—æ®µçš„å€¼
- **æ˜¾ç¤ºå·²åˆ é™¤æ•°æ®**ï¼šé€šè¿‡ `show_deleted=1` å‚æ•°å¯ä»¥æŸ¥çœ‹å·²åˆ é™¤çš„æ•°æ®

## é’©å­æ–¹æ³•ç³»ç»Ÿ

### æ‰§è¡Œæ—¶æœºå›¾
```
åˆ›å»ºæµç¨‹:
FormData â†’ CreateBefore â†’ [äº‹åŠ¡å¼€å§‹] â†’ æ’å…¥æ•°æ® â†’ CreateAfter â†’ [äº‹åŠ¡æäº¤] â†’ CreateReturn

æ›´æ–°æµç¨‹:
FormData â†’ æŸ¥è¯¢åŸå§‹æ•°æ® â†’ UpdateBefore â†’ [äº‹åŠ¡å¼€å§‹] â†’ æ›´æ–°æ•°æ® â†’ UpdateAfter â†’ [äº‹åŠ¡æäº¤] â†’ UpdateReturn

åˆ é™¤æµç¨‹:
è·å–å‚æ•° â†’ æŸ¥è¯¢è¦åˆ é™¤çš„æ•°æ® â†’ DeleteBefore â†’ [äº‹åŠ¡å¼€å§‹] â†’ åˆ é™¤æ•°æ® â†’ DeleteAfter â†’ [äº‹åŠ¡æäº¤] â†’ DeleteReturn

ä¿å­˜æµç¨‹:
åˆ¤æ–­æ˜¯å¦æœ‰ä¸»é”®ID â†’ è°ƒç”¨Createæˆ–Updateæµç¨‹
```

### åˆ›å»ºæ“ä½œé’©å­

#### CreateBefore - åˆ›å»ºå‰é’©å­
```go
// åˆ›å»ºå‰çš„æ•°æ®éªŒè¯å’Œé¢„å¤„ç†
func (i *Index) CreateBefore(modelValue interface{}, mapData map[string]any) (interface{}, map[string]any, error) {
    user := modelValue.(*userModel.Account)

    // éªŒè¯ç”¨æˆ·åæ˜¯å¦å·²å­˜åœ¨
    var count int64
    i.DBI.GetDb().Model(&userModel.Account{}).Where("username = ?", user.Username).Count(&count)
    if count > 0 {
        return nil, nil, errors.New("ç”¨æˆ·åå·²å­˜åœ¨")
    }

    // å¯†ç åŠ å¯†
    if user.Password != "" {
        hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(user.Password), bcrypt.DefaultCost)
        user.Password = string(hashedPassword)
    }

    // è®¾ç½®é»˜è®¤çŠ¶æ€
    if user.Status == 0 {
        user.Status = 1
    }

    return user, mapData, nil
}
```

#### CreateAfter - åˆ›å»ºåé’©å­
```go
// åˆ›å»ºåçš„åç»­å¤„ç†ï¼ˆåœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼‰
func (i *Index) CreateAfter(tx *gorm.DB, modelValue interface{}) error {
    user := modelValue.(*userModel.Account)

    // åˆ›å»ºç”¨æˆ·èµ„æ–™
    profile := &userModel.Profile{
        UserID: user.ID,
        Avatar: "default_avatar.png",
    }
    if err := tx.Create(profile).Error; err != nil {
        return err // è¿”å›é”™è¯¯ä¼šå›æ»šäº‹åŠ¡
    }

    // è®°å½•æ“ä½œæ—¥å¿—
    log.Printf("ç”¨æˆ·åˆ›å»ºæˆåŠŸ: ID=%d, Username=%s", user.ID, user.Username)

    return nil
}
```

#### CreateReturn - åˆ›å»ºè¿”å›é’©å­
```go
// è‡ªå®šä¹‰åˆ›å»ºæˆåŠŸåçš„è¿”å›æ ¼å¼
func (i *Index) CreateReturn(item any) bool {
    user := item.(*userModel.Account)
    // éšè—æ•æ„Ÿä¿¡æ¯
    user.Password = ""
    
    // è‡ªå®šä¹‰è¿”å›æ ¼å¼
    response := map[string]interface{}{
        "message": "ç”¨æˆ·åˆ›å»ºæˆåŠŸ",
        "data":    user,
    }
    
    i.Result(200, "success", response)
    return true
}
```

### æ›´æ–°æ“ä½œé’©å­

#### UpdateBefore - æ›´æ–°å‰é’©å­ â­ ä¼˜åŒ–ç‰ˆ
```go
// æ›´æ–°å‰çš„æ•°æ®éªŒè¯ï¼ˆå¯ä»¥è®¿é—®åŸå§‹æ•°æ®ï¼‰
func (i *Index) UpdateBefore(modelValue interface{}, mapData map[string]any, originalData interface{}) (interface{}, map[string]any, error) {
    user := modelValue.(*userModel.Account)
    original := originalData.(*userModel.Account)

    // å¦‚æœç”¨æˆ·åæœ‰å˜åŒ–ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    if user.Username != original.Username {
        var count int64
        i.DBI.GetDb().Model(&userModel.Account{}).
            Where("username = ? AND id != ?", user.Username, original.ID).
            Count(&count)
        if count > 0 {
            return nil, nil, errors.New("ç”¨æˆ·åå·²å­˜åœ¨")
        }
    }

    // å¦‚æœå¯†ç æœ‰å˜åŒ–ï¼Œè¿›è¡ŒåŠ å¯†
    if user.Password != "" && user.Password != original.Password {
        hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(user.Password), bcrypt.DefaultCost)
        user.Password = string(hashedPassword)
    } else {
        // ä¿æŒåŸå¯†ç 
        user.Password = original.Password
    }

    return user, mapData, nil
}
```

### åˆ é™¤æ“ä½œé’©å­

#### DeleteBefore - åˆ é™¤å‰é’©å­
```go
// åˆ é™¤å‰çš„éªŒè¯å’Œé¢„å¤„ç†
func (i *Index) DeleteBefore(delArr []map[string]interface{}, delIds []interface{}) ([]interface{}, error) {
    // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”æ•°æ®
    for _, item := range delArr {
        userID := item["id"]
        
        // æ£€æŸ¥æ˜¯å¦æœ‰å…³è”çš„è®¢å•
        var orderCount int64
        i.DBI.GetDb().Model(&orderModel.Order{}).Where("user_id = ?", userID).Count(&orderCount)
        if orderCount > 0 {
            return nil, fmt.Errorf("ç”¨æˆ·ID %v è¿˜æœ‰å…³è”çš„è®¢å•ï¼Œæ— æ³•åˆ é™¤", userID)
        }
    }

    return delIds, nil
}
```

#### DeleteAfter - åˆ é™¤åé’©å­
```go
// åˆ é™¤åçš„æ¸…ç†å·¥ä½œï¼ˆåœ¨äº‹åŠ¡å†…æ‰§è¡Œï¼‰
func (i *Index) DeleteAfter(delIds []interface{}, delArr []map[string]interface{}) error {
    // åˆ é™¤ç›¸å…³çš„ç”¨æˆ·èµ„æ–™
    if err := tx.Where("user_id IN ?", delIds).Delete(&userModel.Profile{}).Error; err != nil {
        return err
    }

    // è®°å½•åˆ é™¤æ—¥å¿—
    for _, id := range delIds {
        log.Printf("ç”¨æˆ·åˆ é™¤æˆåŠŸ: ID=%v", id)
    }

    return nil
}
```

### æŸ¥è¯¢æ“ä½œé’©å­

#### ListQuery - åˆ—è¡¨æŸ¥è¯¢æ¡ä»¶
```go
// è®¾ç½®åˆ—è¡¨æŸ¥è¯¢çš„WHEREæ¡ä»¶
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    // åªæ˜¾ç¤ºå¯ç”¨çš„ç”¨æˆ·
    query = query.Where("status = ?", 1)
    
    // æ ¹æ®è¯·æ±‚å‚æ•°æ·»åŠ æœç´¢æ¡ä»¶
    gpc := i.GetSafeMapGPC("all")
    
    if keyword, exists := gpc["keyword"]; exists && keyword != "" {
        query = query.Where("username LIKE ? OR email LIKE ?", 
            "%"+keyword.(string)+"%", "%"+keyword.(string)+"%")
    }
    
    if dept, exists := gpc["department"]; exists && dept != "" {
        query = query.Where("department = ?", dept)
    }

    return query, nil
}
```

#### ListEach - åˆ—è¡¨æ•°æ®å¤„ç†
```go
// å¯¹åˆ—è¡¨ä¸­çš„æ¯ä¸ªæ•°æ®é¡¹è¿›è¡Œå¤„ç†
func (i *Index) ListEach(item interface{}) interface{} {
    user := item.(*userModel.Account)
    
    // éšè—æ•æ„Ÿä¿¡æ¯
    user.Password = ""
    
    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º
    user.CreatedAtFormat = user.CreatedAt.Format("2006-01-02 15:04:05")
    
    // æ·»åŠ è®¡ç®—å­—æ®µ
    user.IsAdmin = user.Role == "admin"
    
    return user
}
```

#### ListSelect - åˆ—è¡¨æŸ¥è¯¢å­—æ®µ
```go
// è®¾ç½®åˆ—è¡¨æŸ¥è¯¢çš„SELECTå­—æ®µ
func (i *Index) ListSelect(query *gorm.DB) *gorm.DB {
    // åªé€‰æ‹©éœ€è¦çš„å­—æ®µï¼Œæé«˜æŸ¥è¯¢æ€§èƒ½
    return query.Select("id, username, email, status, created_at, updated_at")
}
```

#### ListOrder - åˆ—è¡¨æ’åº
```go
// è®¾ç½®åˆ—è¡¨æŸ¥è¯¢çš„æ’åºè§„åˆ™
func (i *Index) ListOrder() interface{} {
    // é»˜è®¤æŒ‰åˆ›å»ºæ—¶é—´å€’åº
    return "created_at DESC, id DESC"
}
```

### ä¿å­˜æ“ä½œé’©å­ â­ å…¼å®¹ç‰ˆ

#### SaveBefore - ä¿å­˜å‰é’©å­
```go
// ä¿å­˜å‰çš„é’©å­æ–¹æ³•ï¼ˆå…¼å®¹åˆ›å»ºå’Œæ›´æ–°ï¼‰
func (i *Index) SaveBefore(modelValue interface{}, mapData map[string]any, originalData ...interface{}) (interface{}, map[string]any, error) {
    user := modelValue.(*userModel.Account)
    
    if len(originalData) > 0 && originalData[0] != nil {
        // æ›´æ–°æ“ä½œ - å¯ä»¥è®¿é—®åŸå§‹æ•°æ®
        original := originalData[0].(*userModel.Account)
        
        // åŸºäºåŸå§‹æ•°æ®è¿›è¡Œå¤„ç†
        if user.Username != original.Username {
            // æ£€æŸ¥ç”¨æˆ·åé‡å¤
            var count int64
            i.DBI.GetDb().Model(&userModel.Account{}).
                Where("username = ? AND id != ?", user.Username, original.ID).
                Count(&count)
            if count > 0 {
                return nil, nil, errors.New("ç”¨æˆ·åå·²å­˜åœ¨")
            }
        }
        
        // å¯†ç å¤„ç†
        if user.Password != "" && user.Password != original.Password {
            hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(user.Password), bcrypt.DefaultCost)
            user.Password = string(hashedPassword)
        } else {
            user.Password = original.Password
        }
    } else {
        // åˆ›å»ºæ“ä½œ - æ²¡æœ‰åŸå§‹æ•°æ®
        
        // æ£€æŸ¥ç”¨æˆ·åé‡å¤
        var count int64
        i.DBI.GetDb().Model(&userModel.Account{}).Where("username = ?", user.Username).Count(&count)
        if count > 0 {
            return nil, nil, errors.New("ç”¨æˆ·åå·²å­˜åœ¨")
        }
        
        // å¯†ç åŠ å¯†
        if user.Password != "" {
            hashedPassword, _ := bcrypt.GenerateFromPassword([]byte(user.Password), bcrypt.DefaultCost)
            user.Password = string(hashedPassword)
        }
        
        // è®¾ç½®é»˜è®¤å€¼
        if user.Status == 0 {
            user.Status = 1
        }
    }

    return user, mapData, nil
}
```

## é«˜çº§åŠŸèƒ½å’Œæœ€ä½³å®è·µ

### è‡ªå®šä¹‰ç»“æœç»“æ„ä½“
```go
// è‡ªå®šä¹‰åˆ—è¡¨è¿”å›ç»“æ„ä½“
type UserListResult struct {
    ID       uint   `gorm:"column:id"`
    Username string `gorm:"column:username"`
    Email    string `gorm:"column:email"`
    Status   int    `gorm:"column:status"`
    IsOnline bool   `gorm:"column:is_online"` // è®¡ç®—å­—æ®µ
}

func New() *Index {
    index := &Index{
        Trait: &crud.Trait{
            Model:            &userModel.Account{},
            DBI:              library.Mysql,
            ListResultStruct: &UserListResult{}, // æŒ‡å®šåˆ—è¡¨ç»“æœç»“æ„ä½“
        },
    }
    
    index.Trait.Controller = index
    return index
}
```

### è¡¨åˆ«åä½¿ç”¨
```go
func New() *Index {
    index := &Index{
        Trait: &crud.Trait{
            Model:           &userModel.Account{},
            DBI:             library.Mysql,
            ModelTableAlias: "u", // è®¾ç½®è¡¨åˆ«å
        },
    }
    
    index.Trait.Controller = index
    return index
}

// åœ¨æŸ¥è¯¢ä¸­ä½¿ç”¨åˆ«å
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    // å¯ä»¥ä½¿ç”¨ u.å­—æ®µå çš„å½¢å¼
    return query.Where("u.status = ?", 1), nil
}
```

### å¤æ‚å…³è”æŸ¥è¯¢
```go
// é¢„åŠ è½½å…³è”æ•°æ®
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    return query.Preload("Profile").Preload("Department"), nil
}

// è¿æ¥æŸ¥è¯¢
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    return query.Joins("LEFT JOIN profiles p ON users.id = p.user_id").
        Select("users.*, p.avatar"), nil
}
```

### æƒé™æ§åˆ¶é›†æˆ
```go
// åŸºäºç”¨æˆ·æƒé™çš„æŸ¥è¯¢è¿‡æ»¤
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    // è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯ï¼ˆå‡è®¾ä»ä¸Šä¸‹æ–‡ä¸­è·å–ï¼‰
    currentUser := i.GetCurrentUser()
    
    if currentUser.Role != "admin" {
        // éç®¡ç†å‘˜åªèƒ½çœ‹åˆ°è‡ªå·±éƒ¨é—¨çš„ç”¨æˆ·
        query = query.Where("department_id = ?", currentUser.DepartmentID)
    }
    
    return query, nil
}

// åˆ é™¤æƒé™æ£€æŸ¥
func (i *Index) DeleteBefore(delArr []map[string]interface{}, delIds []interface{}) ([]interface{}, error) {
    currentUser := i.GetCurrentUser()
    
    // æ£€æŸ¥æ˜¯å¦æœ‰æƒé™åˆ é™¤è¿™äº›ç”¨æˆ·
    for _, item := range delArr {
        userDeptID := item["department_id"]
        if currentUser.Role != "admin" && userDeptID != currentUser.DepartmentID {
            return nil, errors.New("æ²¡æœ‰æƒé™åˆ é™¤å…¶ä»–éƒ¨é—¨çš„ç”¨æˆ·")
        }
    }
    
    return delIds, nil
}
```

### æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### æ‰¹é‡æ“ä½œä¼˜åŒ–
```go
// æ‰¹é‡å¤„ç†ä¼˜åŒ–
func (i *Index) AllQuery(query *gorm.DB) *gorm.DB {
    // ä½¿ç”¨æ‰¹é‡æŸ¥è¯¢ï¼Œé¿å…ä¸€æ¬¡æ€§åŠ è½½å¤§é‡æ•°æ®
    return query.FindInBatches(&results, 1000, func(tx *gorm.DB, batch int) error {
        // æ‰¹é‡å¤„ç†é€»è¾‘
        return nil
    })
}
```

#### æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–
```go
// ç´¢å¼•æç¤ºå’ŒæŸ¥è¯¢ä¼˜åŒ–
func (i *Index) ListSelect(query *gorm.DB) *gorm.DB {
    // åªé€‰æ‹©å¿…è¦çš„å­—æ®µ
    return query.Select("id, username, email, status, created_at")
}

func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    // ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡ŒæŸ¥è¯¢
    if keyword := i.GetGPCString("keyword"); keyword != "" {
        // ä½¿ç”¨ LIKE æŸ¥è¯¢æ—¶ï¼Œç¡®ä¿å­—æ®µæœ‰ç›¸åº”çš„ç´¢å¼•
        query = query.Where("username LIKE ?", keyword+"%") // å‰ç¼€åŒ¹é…æ€§èƒ½æ›´å¥½
    }
    
    return query, nil
}
```

### äº‹åŠ¡å’Œé”å®šå¤„ç†

#### é¿å…é•¿æ—¶é—´é”å®š
```go
// åœ¨ After é’©å­ä¸­é¿å…é•¿æ—¶é—´æ“ä½œ
func (i *Index) CreateAfter(tx *gorm.DB, modelValue interface{}) error {
    user := modelValue.(*userModel.Account)
    
    // è½»é‡çº§çš„æ•°æ®åº“æ“ä½œ
    if err := tx.Create(&userModel.Profile{UserID: user.ID}).Error; err != nil {
        return err
    }
    
    // å°†è€—æ—¶æ“ä½œæ”¾åˆ°äº‹åŠ¡å¤–å¼‚æ­¥æ‰§è¡Œ
    go func() {
        // å‘é€æ¬¢è¿é‚®ä»¶
        i.sendWelcomeEmail(user.Email)
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        i.updateUserStatistics()
    }()
    
    return nil
}
```

#### å¹¶å‘æ§åˆ¶
```go
// ä½¿ç”¨ä¹è§‚é”é˜²æ­¢å¹¶å‘æ›´æ–°å†²çª
func (i *Index) UpdateBefore(modelValue interface{}, mapData map[string]any, originalData interface{}) (interface{}, map[string]any, error) {
    user := modelValue.(*userModel.Account)
    original := originalData.(*userModel.Account)
    
    // æ£€æŸ¥ç‰ˆæœ¬å·ï¼ˆå¦‚æœæ¨¡å‹ä¸­æœ‰ç‰ˆæœ¬å­—æ®µï¼‰
    if user.Version != original.Version {
        return nil, nil, errors.New("æ•°æ®å·²è¢«å…¶ä»–ç”¨æˆ·ä¿®æ”¹ï¼Œè¯·åˆ·æ–°åé‡è¯•")
    }
    
    // é€’å¢ç‰ˆæœ¬å·
    user.Version = original.Version + 1
    
    return user, mapData, nil
}
```

### é”™è¯¯å¤„ç†å’Œæ—¥å¿—

#### ç»Ÿä¸€é”™è¯¯å¤„ç†
```go
func (i *Index) CreateBefore(modelValue interface{}, mapData map[string]any) (interface{}, map[string]any, error) {
    defer func() {
        if r := recover(); r != nil {
            log.Printf("CreateBefore panic: %v", r)
            // å¯ä»¥é€‰æ‹©æ˜¯å¦ç»§ç»­æŠ›å‡º panic
        }
    }()
    
    // ä¸šåŠ¡é€»è¾‘...
    
    return modelValue, mapData, nil
}
```

#### è¯¦ç»†æ—¥å¿—è®°å½•
```go
func (i *Index) UpdateAfter(tx *gorm.DB, modelValue interface{}) error {
    user := modelValue.(*userModel.Account)
    
    // è®°å½•æ“ä½œæ—¥å¿—
    operationLog := &logModel.OperationLog{
        UserID:    i.GetCurrentUserID(),
        Action:    "UPDATE_USER",
        TargetID:  user.ID,
        Details:   fmt.Sprintf("æ›´æ–°ç”¨æˆ·: %s", user.Username),
        CreatedAt: time.Now(),
    }
    
    if err := tx.Create(operationLog).Error; err != nil {
        log.Printf("è®°å½•æ“ä½œæ—¥å¿—å¤±è´¥: %v", err)
        // æ—¥å¿—è®°å½•å¤±è´¥ä¸åº”å½±å“ä¸»è¦ä¸šåŠ¡
    }
    
    return nil
}
```

## è°ƒè¯•å’Œæ•…éšœæ’é™¤

### å¼€å¯è°ƒè¯•æ¨¡å¼
```go
// åœ¨é’©å­æ–¹æ³•ä¸­å¼€å¯æ•°æ®åº“è°ƒè¯•
func (i *Index) ListQuery(query *gorm.DB) (*gorm.DB, error) {
    if os.Getenv("DEBUG") == "true" {
        query = query.Debug() // æ‰“å°SQLè¯­å¥
    }
    
    return query.Where("status = ?", 1), nil
}
```

### å¸¸è§é—®é¢˜è§£å†³

#### æ¨¡å‹è§£æå¤±è´¥
```go
// ç¡®ä¿æ¨¡å‹å®ç°äº† ModelParse æ–¹æ³•
func (u User) ModelParse(modelType reflect.Type) (tableName string, fields []string, softDeleteField string, softDeleteCondition string) {
    // å®ç°ç»†èŠ‚...
    return
}
```

#### è½¯åˆ é™¤ä¸ç”Ÿæ•ˆ
```go
// æ£€æŸ¥è½¯åˆ é™¤å­—æ®µé…ç½®
type User struct {
    base.MysqlBaseModel // ç¡®ä¿ä½¿ç”¨äº†åŸºç¡€æ¨¡å‹
    // æˆ–è€…æ‰‹åŠ¨é…ç½®è½¯åˆ é™¤å­—æ®µ
    DeletedAt *time.Time `gorm:"index" json:"deleted_at"`
}
```

#### äº‹åŠ¡å›æ»šé—®é¢˜
```go
// ç¡®ä¿åœ¨ After é’©å­ä¸­æ­£ç¡®å¤„ç†é”™è¯¯
func (i *Index) CreateAfter(tx *gorm.DB, modelValue interface{}) error {
    // ä»»ä½•é”™è¯¯éƒ½ä¼šå¯¼è‡´äº‹åŠ¡å›æ»š
    if err := tx.Create(&profile).Error; err != nil {
        return err // æ­£ç¡®è¿”å›é”™è¯¯
    }
    
    return nil // è¿”å› nil è¡¨ç¤ºæˆåŠŸ
}
```

## å‡çº§å’Œè¿ç§»æŒ‡å¯¼

### ä»æ—§ç‰ˆæœ¬å‡çº§
1. æ›´æ–°é’©å­æ–¹æ³•ç­¾åï¼ˆç‰¹åˆ«æ˜¯ UpdateBefore å’Œ SaveBeforeï¼‰
2. æ£€æŸ¥è½¯åˆ é™¤å­—æ®µé…ç½®
3. æ›´æ–°é”™è¯¯å¤„ç†é€»è¾‘
4. æµ‹è¯•äº‹åŠ¡è¡Œä¸º

### æ–°åŠŸèƒ½é‡‡ç”¨
1. ä½¿ç”¨æ–°çš„é’©å­æ–¹æ³•ï¼ˆå¦‚ SaveBefore çš„å¯å˜å‚æ•°ï¼‰
2. é‡‡ç”¨æ‰¹é‡æ“ä½œä¼˜åŒ–
3. ä½¿ç”¨æ–°çš„æŸ¥è¯¢é’©å­æ–¹æ³•
4. é›†æˆæ€§èƒ½ç›‘æ§
description:
globs:
alwaysApply: false
---
