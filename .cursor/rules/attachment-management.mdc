# 附件管理组件使用规范

## 组件概述
附件管理组件提供统一的文件上传、存储和管理功能，支持多种存储方式和文件类型。

## 核心文件
- [component/attachment/attachment.go](mdc:component/attachment/attachment.go) - 附件管理主文件
- [component/attachment/method.go](mdc:component/attachment/method.go) - 附件操作方法
- [component/attachment/remote/](mdc:component/attachment/remote/) - 远程存储实现

## 支持的存储方式
- **本地存储**: 文件保存在本地文件系统
- **FTP**: FTP 服务器存储
- **SFTP**: SFTP 安全文件传输
- **OSS**: 阿里云对象存储
- **COS**: 腾讯云对象存储

## 支持的文件类型
- **图片**: .gif, .jpg, .jpeg, .bmp, .png, .ico (最大 5MB)
- **音频**: .mp3, .wma, .wav, .amr (最大 50MB)
- **视频**: .rm, .rmvb, .wmv, .avi, .mpg, .mpeg, .mp4 (最大 300MB)
- **办公文件**: Word、Excel、PowerPoint、PDF 等 (最大 50MB)
- **压缩文件**: .zip, .rar (最大 500MB)

## 基本使用方式

### 初始化附件组件
```go
import (
    "github.com/jcbowen/jcbaseGo/component/attachment"
    "github.com/gin-gonic/gin"
)

func uploadHandler(c *gin.Context) {
    // 基础配置
    baseConfig := &jcbaseGo.AttachmentStruct{
        StorageType:  "local",           // 存储类型
        LocalDir:     "data/attachment", // 本地存储目录
        VisitDomain:  "/",               // 访问域名
    }

    // 远程配置（可选，取决于存储类型）
    var remoteConfig interface{}
    if baseConfig.StorageType == "cos" {
        remoteConfig = jcbaseGo.COSStruct{
            SecretId:  "your-secret-id",
            SecretKey: "your-secret-key",
            Url:       "https://bucket.cos.region.myqcloud.com",
        }
    }

    // 创建附件实例
    att := attachment.New(c, baseConfig, remoteConfig)
}
```

### 文件上传
```go
// 获取上传的文件
file, err := c.FormFile("file")
if err != nil {
    c.JSON(400, gin.H{"error": "获取文件失败"})
    return
}

// 设置上传选项
options := &attachment.Options{
    Group:    "user",     // 文件分组（可选）
    FileData: file,       // 文件数据
    FileType: "image",    // 文件类型
    MaxSize:  2 * 1024 * 1024, // 最大 2MB（可选）
    AllowExt: []string{".jpg", ".png"}, // 允许的扩展名（可选）
}

// 执行上传
result := att.Upload(options).Save()
if result.HasError() {
    c.JSON(400, gin.H{"error": result.Error().Error()})
    return
}

// 返回结果
c.JSON(200, gin.H{
    "success":    true,
    "filename":   result.FileName,
    "size":       result.FileSize,
    "attachment": result.FileAttachment,
    "md5":        result.FileMD5,
    "width":      result.Width,  // 图片宽度
    "height":     result.Height, // 图片高度
})
```

### Base64 文件上传
```go
// Base64 格式的文件数据
base64Data := "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAE..."

options := &attachment.Options{
    FileData: base64Data,
    FileType: "image",
}

result := att.Upload(options).Save()
```

### 字节数组上传
```go
// 直接使用字节数组
fileBytes := []byte("file content...")

options := &attachment.Options{
    FileData: fileBytes,
    FileType: "office",
    AllowExt: []string{".txt"}, // 必须指定扩展名
}

result := att.Upload(options).Save()
```

## 高级功能

### 自定义保存前回调
```go
att.Upload(options).SetBeforeSave(func(a *attachment.Attachment) bool {
    // 在保存前执行自定义逻辑
    // 返回 true 继续保存，返回 false 跳过保存
    
    // 例如：检查文件 MD5 是否已存在
    if isFileExists(a.FileMD5) {
        return false // 跳过保存
    }
    
    // 例如：记录上传日志
    log.Printf("准备保存文件: %s, 大小: %d", a.FileName, a.FileSize)
    
    return true // 继续保存
}).Save()
```

### 文件访问 URL 生成
```go
// 将相对路径转换为完整访问 URL
relativePath := "images/2024/01/filename.jpg"
fullURL := att.ToMedia(relativePath)

// 强制使用本地域名
fullURL := att.ToMedia(relativePath, true)

// 添加时间戳参数以规避缓存（isCache=false 将追加 ?v=timestamp）
fullURL := att.ToMedia(relativePath, false, false)

// 不添加时间戳（默认行为，isCache=true 或省略）
fullURL := att.ToMedia(relativePath, false, true)
```

## 远程存储配置

### 腾讯云 COS
```go
cosConfig := jcbaseGo.COSStruct{
    SecretId:  "your-secret-id",
    SecretKey: "your-secret-key",
    Url:       "https://bucket.cos.region.myqcloud.com",
    CustomizeVisitDomain: "https://your-custom-domain.com/",
}
```

### 阿里云 OSS
```go
ossConfig := jcbaseGo.OSSStruct{
    AccessKeyId:     "your-access-key-id",
    AccessKeySecret: "your-access-key-secret",
    Endpoint:        "oss-region.aliyuncs.com",
    BucketName:      "your-bucket-name",
    CustomizeVisitDomain: "https://your-custom-domain.com/",
}
```

### SFTP
```go
sftpConfig := jcbaseGo.SFTPStruct{
    Address:    "192.168.1.100:22",
    Username:   "username",
    Password:   "password",
    // 或使用私钥
    PrivateKey: privateKeyBytes,
    Timeout:    30 * time.Second,
    CustomizeVisitDomain: "https://your-domain.com/",
}
```

### FTP
```go
ftpConfig := jcbaseGo.FTPStruct{
    Address:  "192.168.1.100:21",
    Username: "username",
    Password: "password",
    Timeout:  30 * time.Second,
    CustomizeVisitDomain: "https://your-domain.com/",
}
```

## 最佳实践

### 错误处理
```go
result := att.Upload(options).Save()
if result.HasError() {
    // 获取第一个错误
    firstError := result.Error()
    
    // 获取所有错误
    allErrors := result.Errors()
    
    // 处理错误
    log.Printf("上传失败: %v", firstError)
    return
}
```

### 文件类型验证
- 使用预定义的文件类型配置，避免手动指定
- 如需自定义，确保 `AllowExt` 和 `MaxSize` 设置合理
- 对于安全敏感的应用，建议额外验证文件内容

### 性能优化
- 大文件上传建议使用分块上传
- 频繁的小文件上传考虑批量处理
- 远程存储建议配置 CDN 加速

### 安全注意事项
- 严格限制上传文件类型和大小
- 对上传的文件名进行安全检查
- 使用随机文件名避免路径遍历攻击
- 定期清理临时文件和无效文件

## 故障排除

### 常见问题
1. **权限错误**: 确保本地存储目录有写入权限
2. **远程连接失败**: 检查网络连接和认证信息
3. **文件类型不支持**: 检查文件扩展名是否在允许列表中
4. **文件大小超限**: 调整 `MaxSize` 配置或压缩文件

### 调试技巧
- 启用详细日志输出
- 检查文件系统权限和磁盘空间
- 验证远程存储配置的正确性
- 使用小文件进行功能测试
description:
globs:
alwaysApply: false
---
