---
globs: "**/orm/**/*.go,**/*_model.go,**/*_dao.go"
description: 数据库和 ORM 操作规范
---

# 数据库和 ORM 操作规范

## ORM 使用原则
- 统一使用 GORM 作为 ORM 框架
- 通过 [component/orm/instance.go](mdc:component/orm/instance.go) 接口进行数据库操作
- 支持 MySQL 和 SQLite 两种数据库

## 数据库连接管理
- MySQL 连接：使用 [component/orm/mysql/main.go](mdc:component/orm/mysql/main.go)
- SQLite 连接：使用 [component/orm/sqlite/main.go](mdc:component/orm/sqlite/main.go)
- 连接配置通过 [config.go](mdc:config.go) 统一管理

## 模型定义规范
```go
// User 用户模型
// 定义用户表的结构和字段映射
type User struct {
    ID        uint      `gorm:"primaryKey" json:"id"`                    // 主键ID
    Username  string    `gorm:"uniqueIndex;size:50" json:"username"`     // 用户名，唯一索引
    Email     string    `gorm:"index;size:100" json:"email"`             // 邮箱，普通索引
    CreatedAt time.Time `gorm:"autoCreateTime" json:"created_at"`        // 创建时间
    UpdatedAt time.Time `gorm:"autoUpdateTime" json:"updated_at"`        // 更新时间
}

// TableName 指定表名
func (User) TableName() string {
    return "users"
}

// ModelParse 解析模型信息（供 CRUD trait 使用）
func (u User) ModelParse(modelType reflect.Type) (tableName string, fields []string) {
    tableName = u.TableName()
    
    for i := 0; i < modelType.NumField(); i++ {
        field := modelType.Field(i)
        if jsonTag := field.Tag.Get("json"); jsonTag != "" && jsonTag != "-" {
            fields = append(fields, strings.Split(jsonTag, ",")[0])
        }
    }
    
    return
}
```

## CRUD 操作规范
使用 [component/trait/crud/](mdc:component/trait/crud/) 提供的 trait 进行 CRUD 操作：

```go
// UserController 用户控制器
type UserController struct {
    crud.Trait
}

// 初始化控制器
func (c *UserController) Init(ctx *gin.Context) {
    c.Model = &User{}
    c.DBI = orm.GetInstance() // 获取数据库实例
    c.Controller = c
    c.InitCrud(ctx)
}

// List 获取用户列表（可选择性覆盖默认实现）
func (c *UserController) List() {
    // 自定义列表逻辑
    // 如果不定义此方法，将使用 trait 中的默认实现
}
```

## 查询优化指导
- 使用索引优化查询性能
- 避免 N+1 查询问题，使用 `Preload` 预加载关联数据
- 大数据量查询使用分页
- 复杂查询考虑使用原生 SQL

## 事务处理
```go
// 使用事务处理多个操作
func (s *Service) CreateUserWithProfile(userData, profileData map[string]interface{}) error {
    return s.db.GetDb().Transaction(func(tx *gorm.DB) error {
        // 创建用户
        if err := tx.Create(&user).Error; err != nil {
            return err
        }
        
        // 创建用户资料
        if err := tx.Create(&profile).Error; err != nil {
            return err
        }
        
        return nil
    })
}
```

## 数据迁移建议
- 使用 GORM 的 AutoMigrate 进行开发环境迁移
- 生产环境使用专门的迁移脚本
- 重要的结构变更需要做好数据备份
